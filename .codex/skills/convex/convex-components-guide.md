# Convex Components Guide

Use components to encapsulate features and build maintainable, reusable backends.

## What Are Components?

Self-contained mini-backends that bundle their own schema, functions, and data:
- **Sandboxed** — can't access main app's tables unless passed as arguments
- **Self-contained** — own schema, functions, and data
- **Reusable** — across projects
- **npm-installable** — from npm or local directories

## When to Use Components

**Use for:** Authentication, file storage, rate limiting, analytics, notifications, search, payments, AI agents, third-party integrations.

**Don't use for:** Core domain models tightly coupled to your app, one-off functionality, simple utilities.

## Installing Components (from npm)

```bash
npm install @convex-dev/ratelimiter
```

```typescript
// convex/convex.config.ts
import { defineApp } from "convex/server";
import ratelimiter from "@convex-dev/ratelimiter/convex.config";

const app = defineApp();
app.use(ratelimiter);
export default app;
```

## Official Components

| Component | Package | Purpose |
|-----------|---------|---------|
| Better Auth | `@convex-dev/better-auth` | Authentication |
| R2 Storage | `@convex-dev/r2` | Cloudflare R2 file storage |
| Polar | `@convex-dev/polar` | Billing/subscriptions |
| Agent | `@convex-dev/agent` | AI agent workflows |
| Rate Limiter | `@convex-dev/ratelimiter` | Rate limiting |
| Aggregate | `@convex-dev/aggregate` | Data aggregations |
| Action Cache | `@convex-dev/action-cache` | Cache action results |
| Sharded Counter | `@convex-dev/sharded-counter` | Distributed counters |
| Migrations | `@convex-dev/migrations` | Data migrations |

Browse: https://www.convex.dev/components
Workflow orchestration is documented separately in `./convex-workflow-guide.md`.

## Creating a Local Component

```bash
mkdir -p convex/components/notifications
```

### Component Config
```typescript
// convex/components/notifications/convex.config.ts
import { defineComponent } from "convex/server";
export default defineComponent("notifications");
```

### Component Schema
```typescript
// convex/components/notifications/schema.ts
import { defineSchema, defineTable } from "convex/server";
import { v } from "convex/values";

export default defineSchema({
  notifications: defineTable({
    userId: v.string(), // Can't use v.id("users") — component is sandboxed
    message: v.string(),
    read: v.boolean(),
    createdAt: v.number(),
  })
    .index("by_user", ["userId"])
    .index("by_user_and_read", ["userId", "read"]),
});
```

### Component Functions
```typescript
// convex/components/notifications/send.ts
import { mutation } from "./_generated/server";
import { v } from "convex/values";

export const send = mutation({
  args: { userId: v.string(), message: v.string() },
  handler: async (ctx, args) => {
    await ctx.db.insert("notifications", {
      userId: args.userId,
      message: args.message,
      read: false,
      createdAt: Date.now(),
    });
  },
});
```

### Register in Host App
```typescript
// convex/convex.config.ts
import { defineApp } from "convex/server";
import notifications from "./components/notifications/convex.config";

const app = defineApp();
app.use(notifications);
export default app;
```

### Use from Host App
```typescript
// convex/tasks.ts
import { components } from "./_generated/api";

export const completeTask = mutation({
  args: { taskId: v.id("tasks") },
  handler: async (ctx, args) => {
    const task = await ctx.db.get(args.taskId);
    await ctx.db.patch(args.taskId, { completed: true });

    // Call component function
    await ctx.runMutation(components.notifications.send.send, {
      userId: task.userId.toString(), // IDs become strings at component boundary
      message: `Task "${task.title}" completed!`,
    });
  },
});
```

## Component Communication Rules

| Pattern | Allowed? | Notes |
|---------|----------|-------|
| Parent → Component | Yes | Main app calls component functions |
| Component receives parent data as args | Yes | Pass IDs/data as function arguments |
| Component → Parent tables | No | Component is sandboxed, can't access host tables |
| Sibling → Sibling | No | Components can't call each other directly; go through parent |

## Key Constraints

- Components can't access `process.env` — pass credentials as function args
- Components can't access `ctx.auth` — pass auth info as args
- Component IDs become plain strings at the boundary
- `_generated/` inside components is auto-generated by `convex dev`
- `query`/`mutation` in a component = "public" (accessible via ComponentApi)
- `internalQuery`/`internalMutation` = private to the component
- HTTP routes can't be defined by components — must be mounted by host

## Directory Structure

```
convex/
├── components/
│   ├── notifications/
│   │   ├── convex.config.ts
│   │   ├── schema.ts
│   │   ├── _generated/       # Auto-generated
│   │   ├── send.ts
│   │   └── read.ts
│   └── analytics/
│       ├── convex.config.ts
│       ├── schema.ts
│       └── track.ts
├── convex.config.ts           # Host app config — uses defineApp() + app.use()
├── schema.ts                  # Host app schema
└── tasks.ts                   # Host app functions
```

## Checklist

- [ ] Check Component Directory for existing solutions before building your own
- [ ] Use `defineApp()` in host `convex.config.ts`
- [ ] Use `defineComponent()` in component `convex.config.ts`
- [ ] Component tables are isolated — can't reference host tables
- [ ] Pass data to components as function arguments (not via shared state)
- [ ] Test components in isolation
- [ ] One concern per component
